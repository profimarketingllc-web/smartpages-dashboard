name: Manual Cloudflare Worker Backup

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Optionaler Backup-Tag (z. B. stable-2026-01-16)"
        required: false
        default: "manual"

permissions:
  contents: write

jobs:
  backup:
    runs-on: ubuntu-latest
    name: Backup Cloudflare Workers

    steps:
      - name: üß© Checkout Repository
        uses: actions/checkout@v4

      - name: üì¶ Install Tools
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: üìÅ Create Backup Folder
        run: mkdir -p backups/workers

      - name: ‚òÅÔ∏è Backup Cloudflare Workers via API
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "üîç Hole Liste aller Cloudflare Worker ..."
          RESPONSE=$(curl -s -w "%{http_code}" -o workers.json \
            -X GET "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/workers/scripts" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json")

          echo "üì° HTTP-Status: ${RESPONSE}"

          if [ "$RESPONSE" -ne 200 ]; then
            echo "‚ùå Fehler beim Abrufen der Worker-Liste!"
            cat workers.json
            exit 1
          fi

          WORKER_NAMES=$(jq -r '.result[].id' workers.json || echo "")
          if [ -z "$WORKER_NAMES" ]; then
            echo "‚ö†Ô∏è Keine Worker gefunden oder Zugriff verweigert"
            cat workers.json
            exit 5
          fi

          echo "üì¶ Gefundene Worker:"
          echo "$WORKER_NAMES"

          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")

          for NAME in $WORKER_NAMES; do
            echo "üß© Sichere Worker: $NAME ..."
            FILE="backups/workers/${NAME}-${TIMESTAMP}.js"

            CODE_RESPONSE=$(curl -s -w "%{http_code}" -o "$FILE" \
              -X GET "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/workers/scripts/${NAME}" \
              -H "Authorization: Bearer ${CF_API_TOKEN}" \
              -H "Content-Type: application/javascript")

            if [ "$CODE_RESPONSE" -ne 200 ]; then
              echo "‚ö†Ô∏è Fehler beim Abrufen von $NAME (Status $CODE_RESPONSE)"
              mv "$FILE" "${FILE}.error"
              continue
            fi

            if grep -q "addEventListener" "$FILE"; then
              echo "‚úÖ Gesichert: $FILE"
            else
              echo "‚ö†Ô∏è WARNUNG: Worker ${NAME} enth√§lt keinen erkennbaren Code ‚Äî markiert."
              mv "$FILE" "${FILE}.invalid"
            fi
          done

      - name: üíæ Commit & Push Backups
        run: |
          git config --global user.name "SmartPages Backup Bot"
          git config --global user.email "backup@smartpages.online"
          git add backups/workers
          git commit -m "üíæ Worker Backup ‚Äì $(date '+%Y-%m-%d %H:%M:%S')" || echo "‚ÑπÔ∏è Keine √Ñnderungen zu committen"
          git push origin HEAD || echo "‚ö†Ô∏è Kein Push m√∂glich (Branch gesch√ºtzt oder keine √Ñnderung)"
