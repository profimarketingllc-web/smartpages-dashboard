name: Manual Astro Project Backup

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Optionaler Backup-Tag (z. B. astro-stable-2026-01-16)"
        required: false
        default: "manual"

permissions:
  contents: write

jobs:
  backup:
    runs-on: ubuntu-latest
    name: Backup Astro Project Structure
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create Backup Folder
        run: mkdir -p backups/astro

      - name: Copy Astro Source Files
        run: |
          echo "ğŸ“¦ Kopiere Astro-Projektstruktur..."
          rsync -av --exclude='node_modules' \
                    --exclude='.astro' \
                    --exclude='dist' \
                    --exclude='.git' \
                    --exclude='.vscode' \
                    ./ ./backups/astro/

      - name: Compress Backups (Hybrid Mode)
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          cd backups

          # ğŸŒ€ Erstelle immer eine aktuelle Sicherung (rolling)
          zip -r "astro-latest.zip" astro

          # ğŸ§­ Erstelle zusÃ¤tzlich einen Snapshot mit Tag und Timestamp
          zip -r "astro-${{ github.event.inputs.tag }}-${TIMESTAMP}.zip" astro

          # ğŸ§¹ TemporÃ¤ren Ordner lÃ¶schen
          rm -rf astro

      - name: Commit & Push Backups
        run: |
          git config --global user.name "SmartPages Backup Bot"
          git config --global user.email "backup@smartpages.online"
          git add backups/
          git commit -m "ğŸ’¾ Astro Backup â€“ $(date '+%Y-%m-%d %H:%M:%S')" || echo "â„¹ï¸ Keine Ã„nderungen zum Commit"
          git push origin HEAD
