---
import { t } from "~/utils/i18n/i18n";

// ğŸ§  User aus Middleware (IMMER Objekt)
const user = Astro.locals?.user ?? {};

// Safe Destructuring
const {
  language = "de",
  first_name = "",
  company_name = "",
  is_business = 0,
  plan = "trial",
  trial_end = null,
  email = "",
  status = "guest",
} = user;

// ğŸ”¹ Defaults
let type = "info";
let messageKey = "neutralGreeting";
let messageVars = "";

// âŒ Kein eingeloggter User â†’ nichts anzeigen
if (status === "guest") {
  messageKey = "neutralGreeting";
}

// ğŸ§® Trial-Logik nur wenn Datum vorhanden
if (plan === "trial" && trial_end) {
  const diff = new Date(trial_end).getTime() - Date.now();
  const daysLeft = Math.ceil(diff / (1000 * 60 * 60 * 24));

  if (daysLeft <= 0) {
    type = "error";
    messageKey = "trialExpired";
  } else if (daysLeft <= 1) {
    type = "warning";
    messageKey = "trialEndingTomorrow";
  } else if (daysLeft <= 3) {
    type = "info";
    messageKey = "trialEndingSoon";
  } else {
    messageKey = "personalized";
  }
}

// ğŸ¢ Business
if (is_business && company_name) {
  messageKey = "businessGreeting";
  messageVars = company_name;
}

// ğŸ‘¤ Privat
if (!is_business && first_name) {
  messageKey = "personalized";
  messageVars = first_name;
}

// ğŸ“© Fallback
if (!messageVars && email) {
  messageVars = email.split("@")[0];
}

const finalMessage = t(language, messageKey, "messages", messageVars);
---

<div class="system-message-container relative flex justify-center">
  <div
    class={`px-5 py-3 rounded-2xl shadow-lg text-white text-sm font-medium
      ${type === "info" && "bg-blue-600"}
      ${type === "warning" && "bg-yellow-500"}
      ${type === "error" && "bg-red-600"}
    `}
  >
    {finalMessage}
  </div>
</div>
