---
import { t } from "~/utils/i18n/i18n";

console.log("ğŸ§© SystemMessage.locals:", Astro.locals.user);
const user = Astro.locals?.user || {};
---

// ğŸ§  Hole Daten direkt aus Middleware (locals.user)
const user = Astro.locals?.user || {};
const {
  language: lang = "de",
  first_name = "",
  company_name = "",
  is_business = 0,
  plan = "trial",
  trial_end = null,
  status = "",
  email = "",
} = user;

// ğŸ§© Standardwerte
let type = "info";
let messageKey = "neutralGreeting";
let messageVars = "";

// ğŸ§® PrÃ¼fe Status
if (plan === "trial" && trial_end) {
  const daysLeft = Math.ceil(
    (new Date(trial_end).getTime() - Date.now()) / (1000 * 60 * 60 * 24)
  );

  if (daysLeft <= 0) {
    type = "error";
    messageKey = "trialExpired";
  } else if (daysLeft === 1) {
    type = "warning";
    messageKey = "trialEndingTomorrow";
  } else if (daysLeft <= 3) {
    type = "info";
    messageKey = "trialEndingSoon";
  } else {
    messageKey = "personalized";
  }
}

// ğŸ¢ Business-Kunden
if (is_business) {
  messageKey = "businessGreeting";
  messageVars = company_name || "";
}

// ğŸ§â€â™‚ï¸ Private Kunden
if (!is_business && first_name) {
  messageKey = "personalized";
  messageVars = first_name;
}

// Wenn kein Name, fallback auf E-Mail
if (!messageVars && email) {
  messageVars = email.split("@")[0];
}

// ğŸ“© Ãœbersetzung abrufen
const finalMessage = t(lang, messageKey, "messages", messageVars);
---

<div class="system-message-container relative flex flex-col justify-center">
  <div
    class={`relative flex flex-col justify-center p-5 rounded-2xl shadow-lg border border-white/20 bg-gradient-to-br text-white transition-all duration-300
      ${type === "info" ? "from-blue-500 to-blue-600" : ""}
      ${type === "warning" ? "from-yellow-500 to-orange-600" : ""}
      ${type === "error" ? "from-red-500 to-red-600" : ""}
    `}
  >
    <p class="text-sm leading-relaxed text-white/90 text-center font-medium">
      {finalMessage}
    </p>
  </div>
</div>
