---
import "~/styles/global.css";
import SmartHeader from "~/components/shared/SmartHeader.astro";
import SmartSidebar from "~/components/shared/SmartSidebar.astro";
import { t } from "~/utils/i18n/i18n";

const {
  sidebar = true,
  header = true,
  lang = "en",
  page = null,
} = Astro.props;

// ðŸ§  Titel & Description aus i18n
const pageTitle = page
  ? t(lang, page, "page", "title")
  : "SmartPages";

const pageDescription = page
  ? t(lang, page, "page", "description")
  : null;
---
<!DOCTYPE html>
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>SmartPages â€“ {pageTitle}</title>

    {pageDescription && (
      <meta name="description" content={pageDescription} />
    )}
  </head>

  <body>
    <div class="min-h-screen flex font-sans bg-[#F7F8FA] text-smart-text">
      {sidebar && <SmartSidebar />}

      <div class={`flex-1 flex flex-col ${sidebar ? "md:ml-64" : ""}`}>
        {header && <SmartHeader />}

        <main class="flex-1 px-4 py-4 max-w-[1500px] w-full mx-auto">
          <slot />
        </main>

        <footer class="text-center text-sm text-gray-500 py-4 border-t bg-white/80">
          Â© SmartPages
        </footer>
      </div>
    </div>

    <!-- ===================================================== -->
    <!-- ðŸ” CLIENT BOOTSTRAP (LANG + USER CONTEXT)             -->
    <!-- ===================================================== -->
    <script>
      (async function bootstrapSmartPagesContext() {
        window.SMARTPAGES_LANG = "en";
        window.SMARTPAGES_USER = null;

        try {
          const res = await fetch("/api/session/userinfo", {
            credentials: "include",
            headers: { "Accept": "application/json" },
          });

          if (!res.ok) throw new Error("userinfo fetch failed");

          const data = await res.json();

          if (data?.ok && data.user) {
            window.SMARTPAGES_USER = data.user;

            if (data.user.language) {
              window.SMARTPAGES_LANG = data.user.language;
            }
          }
        } catch (err) {
          console.warn("[SmartPages] Using fallback language/user");
        }

        window.dispatchEvent(
          new CustomEvent("smartpages:context-ready", {
            detail: {
              lang: window.SMARTPAGES_LANG,
              user: window.SMARTPAGES_USER,
            },
          })
        );
      })();
    </script>
  </body>
</html>
