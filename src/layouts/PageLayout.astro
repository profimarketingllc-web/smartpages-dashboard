---
import "~/styles/global.css";
import SmartHeader from "~/components/shared/SmartHeader.astro";
import SmartSidebar from "~/components/shared/SmartSidebar.astro";

const {
  sidebar = true,
  header = true,
  sticky = true,
  headerOffset = "compact",
} = Astro.props;

const headerOffsetClass =
  headerOffset === "compact" ? "mt-2 md:mt-3" : "mt-12";

const stickyClass = sticky ? "sticky top-0 z-50" : "";
---

<div class="min-h-screen flex font-sans text-smart-text bg-[#F7F8FA] antialiased">
  {
    sidebar ? (
      <>
        <SmartSidebar collapsible />

        <div class="flex-1 flex flex-col md:ml-64">
          {header && (
            <div class={stickyClass}>
              <SmartHeader />
            </div>
          )}

          <main
            class={`flex-1 px-2 sm:px-4 md:px-6 lg:px-8 xl:px-10 py-3 md:py-4 
              ${header ? headerOffsetClass : ""} 
              max-w-[1500px] w-full mx-auto`}
          >
            <slot />
          </main>

          <footer class="text-center text-sm text-gray-500 py-4 border-t bg-white/80">
            漏 {new Date().getFullYear()} SmartPages 路 Hosted in Europe 路 GDPR-compliant
          </footer>
        </div>
      </>
    ) : (
      <div class="flex-1 flex flex-col min-h-screen bg-white">
        {header && (
          <div class={stickyClass}>
            <SmartHeader />
          </div>
        )}

        <main class="flex-1 px-4 md:px-8 lg:px-10 py-4 md:py-6">
          <slot />
        </main>

        <footer class="text-center text-sm text-gray-500 py-4 border-t bg-white/80">
          漏 {new Date().getFullYear()} SmartPages 路 Hosted in Europe 路 GDPR-compliant
        </footer>
      </div>
    )
  }
</div>

<!-- ========================================================= -->
<!--  CLIENT-SIDE AUTH GUARD (STATIC ASTRO)                  -->
<!-- ========================================================= -->
<script>
  (async function () {
    try {
      const res = await fetch(
        "https://api.smartpages.online/api/session/userinfo",
        {
          credentials: "include"
        }
      );

      if (!res.ok) {
        window.location.href = "/login";
        return;
      }

      const data = await res.json();

      if (!data.ok || !data.user) {
        window.location.href = "/login";
        return;
      }

      // Global verf眉gbar f眉r Header, Sidebar, Pages
      window.SMARTPAGES_USER = data.user;

    } catch (err) {
      console.error("[AuthGuard] failed", err);
      window.location.href = "/login";
    }
  })();
</script>
