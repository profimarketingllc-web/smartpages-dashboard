---
import "~/styles/global.css";
import SmartHeader from "~/components/shared/SmartHeader.astro";
import SmartSidebar from "~/components/shared/SmartSidebar.astro";

const {
  sidebar = true,
  header = true,
} = Astro.props;
---

<div class="min-h-screen flex font-sans bg-[#F7F8FA] text-smart-text">
  {sidebar && <SmartSidebar />}

  <div class={`flex-1 flex flex-col ${sidebar ? "md:ml-64" : ""}`}>
    {header && <SmartHeader />}

    <main class="flex-1 px-4 py-4 max-w-[1500px] w-full mx-auto">
      <slot />
    </main>

    <footer class="text-center text-sm text-gray-500 py-4 border-t bg-white/80">
      Â© SmartPages
    </footer>
  </div>
</div>

<!-- ===================================================== -->
<!-- ðŸ” CLIENT BOOTSTRAP (LANG + USER CONTEXT)             -->
<!-- ===================================================== -->
<script>
  (async function bootstrapSmartPagesContext() {
    // ðŸ›¡ harte, sichere Defaults (build-safe)
    window.SMARTPAGES_LANG = "en";
    window.SMARTPAGES_USER = null;

    try {
      const res = await fetch("/api/session/userinfo", {
        credentials: "include",
        headers: { "Accept": "application/json" },
      });

      if (!res.ok) throw new Error("userinfo fetch failed");

      const data = await res.json();

      if (data?.ok && data.user) {
        window.SMARTPAGES_USER = data.user;

        if (data.user.language) {
          window.SMARTPAGES_LANG = data.user.language;
        }
      }
    } catch (err) {
      // bewusst leer: Fallbacks bleiben aktiv
      console.warn("[SmartPages] Using fallback language/user");
    }

    // ðŸ”” ZENTRALES SIGNAL (Ersatz fÃ¼r locals / middleware)
    window.dispatchEvent(
      new CustomEvent("smartpages:context-ready", {
        detail: {
          lang: window.SMARTPAGES_LANG,
          user: window.SMARTPAGES_USER,
        },
      })
    );
  })();
</script>
