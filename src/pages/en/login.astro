---
import "~/styles/global.css";
import ProductGrid from "~/components/shared/ProductGrid.astro";
import { t } from "~/utils/i18n/i18n";

const lang = "en";

const products = [
  {
    key: "smartprofile",
    title: t(lang, "login", "products", "smartprofile", "title"),
    label: t(lang, "login", "products", "smartprofile", "label"),
    text: t(lang, "login", "products", "smartprofile", "text"),
  },
  {
    key: "smartpage",
    title: t(lang, "login", "products", "smartpage", "title"),
    label: t(lang, "login", "products", "smartpage", "label"),
    text: t(lang, "login", "products", "smartpage", "text"),
  },
  {
    key: "smartdomain",
    title: t(lang, "login", "products", "smartdomain", "title"),
    label: t(lang, "login", "products", "smartdomain", "label"),
    text: t(lang, "login", "products", "smartdomain", "text"),
  },
];
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SmartPages Login</title>
    <meta
      name="description"
      content="Login to SmartPages – secure, privacy-first and hosted in Europe."
    />
  </head>

  <body class="bg-white text-gray-800 font-inter pt-24 overflow-x-hidden">

    <main class="max-w-3xl mx-auto px-6 space-y-8">

      <!-- LOGIN FORM -->
      <section>
        <form
          id="magicForm"
          class="bg-white p-6 rounded-xl flex flex-col gap-4 shadow-sm"
        >
          <label>First name *</label>
          <input name="first_name" required />

          <label>Last name</label>
          <input name="last_name" />

          <label>Email *</label>
          <input type="email" name="email" required />

          <button
            type="submit"
            class="bg-[#F5B400] text-white py-2 rounded font-semibold"
          >
            Send Magic Link
          </button>

          <div id="formMessage" class="text-sm mt-2"></div>
        </form>
      </section>

      <!-- PRODUCT GRID (SAFE WRAPPER) -->
      <section>
        <ProductGrid products={products} compact />
      </section>

    </main>

    <!-- MAGIC LINK HANDLER -->
    <script>
      const form = document.getElementById("magicForm");
      const msg = document.getElementById("formMessage");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        msg.textContent = "";

        const data = Object.fromEntries(new FormData(form));

        try {
          const res = await fetch("https://api.smartpages.online/api/auth/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ ...data, lang: "en" }),
          });

          const result = await res.json();

          if (result.ok) {
            msg.innerHTML =
              "✅ Magic link sent.<br><small>This window will close automatically.</small>";
            msg.className = "text-green-600";

            setTimeout(() => {
              window.close();
              setTimeout(() => {
                msg.innerHTML += "<br>You can close this window now.";
              }, 300);
            }, 8000);
          } else {
            msg.textContent = "❌ Failed to send magic link.";
            msg.className = "text-red-600";
          }
        } catch {
          msg.textContent = "❌ Network error.";
          msg.className = "text-red-600";
        }
      });
    </script>

  </body>
</html>
