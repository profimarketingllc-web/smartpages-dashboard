---
import "~/styles/global.css";
import ProductGrid from "~/components/shared/ProductGrid.astro";
import { t } from "~/utils/i18n/i18n";

const lang = "en";
---

<html lang="en">
  <body class="bg-white text-gray-800 font-inter pt-24 overflow-x-hidden">

    <form
      id="magicForm"
      class="bg-white p-6 rounded-xl flex flex-col gap-4 shadow-sm max-w-md mx-auto"
    >
      <label>First name *</label>
      <input name="first_name" required />

      <label>Last name</label>
      <input name="last_name" />

      <label>Email *</label>
      <input type="email" name="email" required />

      <button type="submit" class="bg-[#F5B400] text-white py-2 rounded">
        Send magic link
      </button>

      <div id="formMessage" class="text-sm mt-2"></div>
    </form>

    <script>
      const form = document.getElementById("magicForm");
      const msg = document.getElementById("formMessage");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        msg.textContent = "";

        const data = Object.fromEntries(new FormData(form));

        try {
          const res = await fetch("https://api.smartpages.online/api/auth/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ ...data, lang: "en" }),
          });

          const result = await res.json();

          if (result.ok) {
            msg.innerHTML =
              "✅ Magic link sent.<br><small>This window will close automatically.</small>";
            msg.className = "text-green-600";

            setTimeout(() => {
              window.close();
              setTimeout(() => {
                msg.innerHTML +=
                  "<br><span class='text-gray-500'>You may now close this window.</span>";
              }, 300);
            }, 8000);
          } else {
            msg.textContent = "❌ Failed to send magic link.";
            msg.className = "text-red-600";
          }
        } catch {
          msg.textContent = "❌ Network error.";
          msg.className = "text-red-600";
        }
      });
    </script>
  </body>
</html>
