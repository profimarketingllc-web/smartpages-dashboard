---
/**
 * ğŸ” SmartPages Redirect Page â€“ v2 (Cookie-stabil & Core-integriert)
 * Funktioniert mit SmartCore Worker v8.9.2+
 */
---

<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <title>SmartPages Anmeldung</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        background: #0b0d17;
        color: white;
        font-family: sans-serif;
        text-align: center;
        margin-top: 20vh;
      }
      .msg {
        font-size: 1.1rem;
        opacity: 0.9;
      }
      .loader {
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-left-color: #3b82f6;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        margin: 20px auto;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>

  <body>
    <h2>ğŸ” Anmeldung wird Ã¼berprÃ¼ft...</h2>
    <div class="loader"></div>
    <p class="msg" id="statusText">Bitte warten...</p>

    <script is:inline>
      (async () => {
        const url = new URL(window.location.href);
        const token = url.searchParams.get("token");
        const lang = url.searchParams.get("lang") || "de";
        const statusText = document.getElementById("statusText");

        const showMessage = (msg, color = "#ccc") => {
          statusText.textContent = msg;
          statusText.style.color = color;
        };

        if (!token) {
          showMessage("âŒ Kein Token gefunden.", "#ef4444");
          return;
        }

        try {
          // 1ï¸âƒ£ Token verifizieren
          const verifyRes = await fetch(
            `https://api.smartpages.online/api/auth/verify?token=${token}&lang=${lang}`,
            { credentials: "include" }
          );
          const verifyData = await verifyRes.json();

          if (!verifyData.ok || !verifyData.redirect) {
            showMessage("âš ï¸ Token ungÃ¼ltig oder abgelaufen.", "#facc15");
            return;
          }

          showMessage("Token geprÃ¼ft â€“ Session wird erstellt...");

          // 2ï¸âƒ£ Session bestÃ¤tigen (setzt Cookie)
          const confirmRes = await fetch(
            `https://api.smartpages.online${verifyData.redirect}`,
            { credentials: "include" }
          );
          const confirmData = await confirmRes.json();

          if (confirmData.ok && confirmData.message === "session_set") {
            showMessage("âœ… Anmeldung erfolgreich! Leite weiter...");

            // 3ï¸âƒ£ Kurze Pause, dann Redirect ins Dashboard
            setTimeout(() => {
              window.location.href =
                confirmData.redirect ||
                `https://desk.smartpages.online/${lang}/dashboard`;
            }, 1200);
          } else {
            showMessage("âš ï¸ Fehler beim BestÃ¤tigen der Anmeldung.", "#facc15");
          }
        } catch (err) {
          console.error(err);
          showMessage(`âŒ Fehler: ${err.message}`, "#ef4444");
        }
      })();
    </script>
  </body>
</html>
