---
import { onMount } from "astro/jsx-runtime";

onMount(async () => {
  const url = new URL(window.location.href);
  const token = url.searchParams.get("token");
  const lang = url.searchParams.get("lang") || "de";

  const message = (txt: string) => {
    document.body.innerHTML = `<p style="font-family:sans-serif;text-align:center;margin-top:20vh;">${txt}</p>`;
  };

  if (!token) {
    message("‚ùå Kein Token gefunden.");
    return;
  }

  try {
    // 1Ô∏è‚É£ Verify
    const verifyRes = await fetch(`https://api.smartpages.online/api/auth/verify?token=${token}&lang=${lang}`);
    const verifyData = await verifyRes.json();

    if (!verifyData.ok || !verifyData.redirect) {
      message("‚ö†Ô∏è Token ung√ºltig oder abgelaufen.");
      return;
    }

    // 2Ô∏è‚É£ Confirm
    const confirmRes = await fetch(`https://api.smartpages.online${verifyData.redirect}`, {
      credentials: "include",
    });
    const confirmData = await confirmRes.json();

    if (confirmData.ok && confirmData.redirect) {
      // 3Ô∏è‚É£ Redirect ins Dashboard
      window.location.href = confirmData.redirect;
    } else {
      message("‚ö†Ô∏è Fehler beim Best√§tigen der Anmeldung.");
    }
  } catch (err) {
    message(`‚ùå Fehler: ${err.message}`);
  }
});
---

<html>
  <head>
    <title>SmartPages Login</title>
  </head>
  <body style="background-color:#0b0d17;color:white;font-family:sans-serif;text-align:center;margin-top:20vh;">
    <h2>üîê Anmeldung wird √ºberpr√ºft...</h2>
  </body>
</html>
