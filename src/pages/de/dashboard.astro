---
import PageLayout from "~/layouts/PageLayout.astro";
import DashboardCardWide from "~/components/core/DashboardCardWide.astro";
import "~/styles/global.css";

let user = null;
let authenticated = false;

// ğŸ§© Serverseitiger Session-Fallback (Cookie aus Request-Header)
try {
  const cookie = Astro.request.headers.get("cookie") || "";
  if (cookie.includes("session=")) {
    const res = await fetch("https://api.smartpages.online/api/session", {
      method: "GET",
      headers: {
        "Accept": "application/json",
        "Cookie": cookie, // ğŸ”’ Serverseitiger Sessioncheck
      },
      credentials: "include",
    });

    const data = await res.json();
    if (data.ok && data.authenticated) {
      user = data.user;
      authenticated = true;
    }
  }
} catch (err) {
  console.warn("Server-side session check failed:", err);
}
---

<PageLayout title="Dashboard â€“ SmartPages" sidebar={true} header={true}>
  {authenticated ? (
    <>
      <!-- ğŸ§­ Dashboard -->
      <DashboardCardWide
        title={`Willkommen zurÃ¼ck, ${user?.first_name || "Unbekannt"} ğŸ‘‹`}
        showStatus={true}
        status="Eingeloggt"
        statusColor="green"
      >
        <p class="text-gray-700">Du bist erfolgreich angemeldet!</p>
      </DashboardCardWide>
    </>
  ) : (
    <div class="max-w-4xl mx-auto mt-20 text-center" id="login-status">
      <h2 class="text-2xl font-bold text-[#1E2A45]">Anmeldung wird geprÃ¼ft...</h2>
    </div>
  )}
</PageLayout>

<script>
window.addEventListener("DOMContentLoaded", async () => {
  try {
    // ğŸ” Clientseitiger Session-Check nach Redirect
    const res = await fetch("https://api.smartpages.online/api/session", {
      method: "GET",
      credentials: "include", // ğŸ‘ˆ wichtig: sendet Cookie mit
      headers: {
        "Accept": "application/json",
      },
    });

    const data = await res.json();

    if (data.ok && data.authenticated) {
      // Benutzer ist eingeloggt â†’ Seite neuladen mit Userdaten
      location.reload();
    } else {
      // Kein Login â†’ Login-Block anzeigen
      document.getElementById("login-status").innerHTML = `
        <h2 class='text-2xl font-bold text-[#1E2A45]'>Anmeldung erforderlich</h2>
        <p class='text-gray-600 mt-3'>Bitte melde dich erneut Ã¼ber deinen Magic Link an.</p>
        <a href="/de/login"
           class="inline-block mt-6 px-6 py-3 bg-[#F5B400] text-[#1E2A45] rounded-xl hover:bg-[#E47E00] transition-all">
           Zum Login
        </a>`;
    }
  } catch (e) {
    console.error("Client session fetch failed:", e);
    document.getElementById("login-status").innerHTML = `
      <h2 class='text-2xl font-bold text-[#1E2A45]'>Verbindungsfehler</h2>
      <p class='text-gray-600 mt-3'>Bitte versuche es in ein paar Minuten erneut.</p>`;
  }
});
</script>

<style>
body {
  font-family: "Inter", sans-serif;
  background-color: #f9fafb;
}
</style>
