---
import PageLayout from "~/layouts/PageLayout.astro";
import DashboardCardWide from "~/components/core/DashboardCardWide.astro";
import "~/styles/global.css";

let user = null;
let authenticated = false;

try {
  const cookie = Astro.request.headers.get("cookie") || "";
  if (cookie.includes("session=")) {
    const res = await fetch("https://api.smartpages.online/api/session", {
      method: "GET",
      headers: { "Accept": "application/json", "Cookie": cookie },
      credentials: "include",
    });
    const data = await res.json();
    if (data.ok && data.authenticated) {
      user = data.user;
      authenticated = true;
    }
  }
} catch (err) {
  console.warn("Server-side session check failed:", err);
}
---

<PageLayout title="Dashboard â€“ SmartPages" sidebar={true} header={true}>
  <div id="dashboard-content" class="max-w-5xl mx-auto mt-16">
    {authenticated ? (
      <>
        <DashboardCardWide
          title={`Willkommen zurÃ¼ck, ${user?.first_name || "Unbekannt"} ðŸ‘‹`}
          showStatus={true}
          status="Eingeloggt"
          statusColor="green"
        >
          <p class="text-gray-700">Du bist erfolgreich angemeldet.</p>
        </DashboardCardWide>

        <div id="customer-card"
             class="mt-10 rounded-2xl shadow bg-white p-8 text-center border border-gray-100">
          <h3 class="text-xl font-bold text-[#1E2A45] mb-2">
            Kundendaten werden geladen...
          </h3>
          <p class="text-gray-500 text-sm">Bitte einen Moment Geduld.</p>
        </div>
      </>
    ) : (
      <div class="max-w-4xl mx-auto mt-20 text-center" id="login-status">
        <h2 class="text-2xl font-bold text-[#1E2A45]">Anmeldung wird geprÃ¼ft...</h2>
      </div>
    )}
  </div>
</PageLayout>

<script>
window.addEventListener("DOMContentLoaded", async () => {
  const container = document.getElementById("dashboard-content");
  const statusBox = document.getElementById("login-status");

  try {
    const res = await fetch("https://api.smartpages.online/api/session", {
      method: "GET",
      credentials: "include",
      headers: { "Accept": "application/json" },
    });

    const data = await res.json();

    if (data.ok && data.authenticated) {
      const user = data.user;

      container.innerHTML = [
        '<div class="rounded-2xl shadow bg-white p-8 text-center mb-10">',
        `<h2 class="text-3xl font-bold text-[#1E2A45]">Willkommen zurÃ¼ck, ${user.first_name || "Unbekannt"} ðŸ‘‹</h2>`,
        '<p class="mt-2 text-gray-600">Du bist erfolgreich angemeldet.</p>',
        "</div>",
        '<div id="customer-card" class="rounded-2xl shadow bg-white p-8 text-center border border-gray-100">',
        '<h3 class="text-xl font-bold text-[#1E2A45] mb-2">Kundendaten werden geladen...</h3>',
        '<p class="text-gray-500 text-sm">Bitte einen Moment Geduld.</p>',
        "</div>"
      ].join("");

      const customerRes = await fetch(
        `https://customer.smartpages.online/api/customer?email=${encodeURIComponent(user.email)}`,
        { credentials: "include", headers: { "Accept": "application/json" } }
      );

      const customerData = await customerRes.json();
      const card = document.getElementById("customer-card");

      if (customerData.ok && customerData.profile) {
        const p = customerData.profile;
        card.innerHTML = [
          '<h3 class="text-xl font-bold text-[#1E2A45] mb-4">Kundendaten</h3>',
          '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left max-w-2xl mx-auto">',
          `<div><strong>Name:</strong> ${p.first_name} ${p.last_name || ""}</div>`,
          `<div><strong>Email:</strong> ${p.email}</div>`,
          `<div><strong>Kundennummer:</strong> ${p.customer_no || "-"}</div>`,
          `<div><strong>Firma:</strong> ${p.company_name || "-"}</div>`,
          `<div><strong>Sprache:</strong> ${p.language || "de"}</div>`,
          "</div>"
        ].join("");
      } else {
        card.innerHTML = [
          '<h3 class="text-xl font-bold text-[#1E2A45] mb-2">Keine Kundendaten gefunden</h3>',
          '<p class="text-gray-500">Bitte Ã¼berprÃ¼fe deine Kontoeinstellungen.</p>'
        ].join("");
      }
    } else {
      statusBox.innerHTML = [
        "<h2 class='text-2xl font-bold text-[#1E2A45]'>Anmeldung erforderlich</h2>",
        "<p class='text-gray-600 mt-3'>Bitte melde dich erneut Ã¼ber deinen Magic Link an.</p>",
        "<a href='/de/login' class='inline-block mt-6 px-6 py-3 bg-[#F5B400] text-[#1E2A45] rounded-xl hover:bg-[#E47E00] transition-all'>Zum Login</a>"
      ].join("");
    }
  } catch (e) {
    console.error("Client session fetch failed:", e);
    statusBox.innerHTML = [
      "<h2 class='text-2xl font-bold text-[#1E2A45]'>Verbindungsfehler</h2>",
      "<p class='text-gray-600 mt-3'>Bitte versuche es in ein paar Minuten erneut.</p>"
    ].join("");
  }
});
</script>

<style>
body {
  font-family: "Inter", sans-serif;
  background-color: #f9fafb;
}
</style>
