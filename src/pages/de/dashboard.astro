---
import PageLayout from "~/layouts/PageLayout.astro";
import "~/styles/global.css";

let user = null;
let authenticated = false;

try {
  const cookie = Astro.request.headers.get("cookie") || "";
  const res = await fetch("https://api.smartpages.online/api/user/profile", {
    method: "GET",
    headers: { Accept: "application/json", Cookie: cookie },
    credentials: "include",
  });
  const data = await res.json();
  if (data.ok && data.user) {
    authenticated = true;
    user = data.user;
  }
} catch (err) {
  console.warn("Serverseitiger Session-Check fehlgeschlagen:", err);
}
---

<PageLayout title="Dashboard ‚Äì SmartPages" sidebar={true} header={true}>
  <div id="dashboard-wrapper" class={authenticated ? "" : "hidden"}>
    <!-- üî∏ Hinweisbanner (Status) -->
    {user?.status === "inactive" && (
      <div class="bg-[#FFF8E1] border border-[#E6C75C] text-[#6A5F1E] text-sm rounded-xl p-3 mx-auto max-w-5xl mb-4 shadow-sm">
        ‚ö†Ô∏è Dein Account ist noch nicht aktiviert. Bitte √ºberpr√ºfe deine Angaben oder upgrade deinen Plan.
      </div>
    )}
    {user?.status === "cancelled" && (
      <div class="bg-[#FCE8E8] border border-[#D66A6A] text-[#6A1E1E] text-sm rounded-xl p-3 mx-auto max-w-5xl mb-4 shadow-sm">
        ‚ùå Dein Zugang wurde deaktiviert. Kontaktiere bitte den Support f√ºr eine Reaktivierung.
      </div>
    )}

    <!-- üß≠ Kundendaten -->
    <section class="max-w-6xl mx-auto bg-gray-50 border border-gray-200 shadow-lg rounded-3xl p-6 mt-0">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
        <div class="w-full">
          <h2 class="text-2xl font-bold mb-3">
            Willkommen zur√ºck, {user?.first_name || "Gastbenutzer"} üëã
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-x-10 gap-y-2 text-sm text-gray-700">
            <p><span class="font-semibold">Name:</span> {user?.first_name || "-"} {user?.last_name || ""}</p>
            <p><span class="font-semibold">E-Mail:</span> {user?.email || "-"}</p>
            <p><span class="font-semibold">Status:</span> {user?.status || "-"}</p>
            <p><span class="font-semibold">Plan:</span> {user?.plan || "-"}</p>
            <p><span class="font-semibold">Aktiv seit:</span> {user?.created_at || "-"}</p>
            <p><span class="font-semibold">Letzter Login:</span> {user?.last_login || "-"}</p>
          </div>
          <div class="flex justify-center mt-3">
            <button
              id="editUserBtn"
              class="px-6 py-2 text-white rounded-xl shadow-md font-medium bg-gradient-to-r from-[#F5B400] to-[#E47E00] hover:opacity-90 transition-all duration-300">
              Kundendaten bearbeiten
            </button>
          </div>
        </div>
        <div class="mt-3 md:mt-0 md:ml-6">
          <span
            class="inline-block px-4 py-1 text-sm rounded-full border font-medium min-w-[110px] text-center"
            class:list={{
              "bg-[#C8F3C1] text-[#1E2A45] border-[#B1E6AA]": user?.status === "active",
              "bg-[#FFF3B0] text-[#665C00] border-[#E5D16A]": user?.status === "inactive",
              "bg-[#FCDCDC] text-[#8A1E1E] border-[#E5A1A1]": user?.status === "cancelled",
            }}>
            {user?.status || "Unbekannt"}
          </span>
        </div>
      </div>
    </section>

    <!-- üßæ Impressumsdaten -->
    <section class="max-w-6xl mx-auto bg-gray-50 border border-gray-200 shadow-lg rounded-3xl p-6 mt-4">
      <h2 class="text-xl font-semibold mb-3 text-[#1E2A45]">Impressumsdaten</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-3 text-sm text-gray-700">
        <p><span class="font-semibold">Unternehmen:</span> {user?.imprint?.company_name || "‚Äì"}</p>
        <p><span class="font-semibold">Ansprechpartner:</span> {user?.imprint?.contact_name || "‚Äì"}</p>
        <p><span class="font-semibold">Stra√üe:</span> {user?.imprint?.street || "‚Äì"}</p>
        <p><span class="font-semibold">Hausnummer:</span> {user?.imprint?.house_number || "‚Äì"}</p>
        <p><span class="font-semibold">PLZ / Ort:</span> {user?.imprint?.zip || "‚Äì"} {user?.imprint?.city || ""}</p>
        <p><span class="font-semibold">Land:</span> {user?.imprint?.country || "Deutschland"}</p>
        <p><span class="font-semibold">E-Mail (Support):</span> {user?.imprint?.support_email || user?.email || "‚Äì"}</p>
        <p><span class="font-semibold">Telefon:</span> {user?.imprint?.phone || "‚Äì"}</p>
        <p><span class="font-semibold">USt-ID:</span> {user?.imprint?.vat_id || "‚Äì"}</p>
      </div>

      <div class="flex justify-center mt-4">
        <button
          id="editImprintBtn"
          class="px-6 py-2 text-white rounded-xl shadow-md font-medium bg-gradient-to-r from-[#F5B400] to-[#E47E00] hover:opacity-90 transition-all duration-300">
          Impressum bearbeiten
        </button>
      </div>
    </section>

    <!-- üß± Produkt-Kacheln -->
    <section class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-5 p-5 mt-4">
      <a href="/de/smartprofile" class="rounded-2xl p-5 text-white bg-gradient-to-r from-[#4E6BFF] to-[#657AFF]
        shadow-[0_6px_16px_rgba(0,0,0,0.12)] transition-all duration-300 hover:shadow-[0_0_25px_rgba(78,107,255,0.6)] hover:scale-[1.02]">
        <h3 class="text-2xl font-bold mb-2">SmartProfile</h3>
        <p class="text-sm">Erstelle dein pers√∂nliches Profil mit nur wenigen Klicks ‚Äì perfekt f√ºr Freelancer, Coaches und Unternehmer.</p>
      </a>
      <a href="/de/smartpage" class="rounded-2xl p-5 text-white bg-gradient-to-r from-[#F5B400] to-[#E47E00]
        shadow-[0_6px_16px_rgba(0,0,0,0.12)] transition-all duration-300 hover:shadow-[0_0_25px_rgba(245,180,0,0.6)] hover:scale-[1.02]">
        <h3 class="text-2xl font-bold mb-2">SmartPage</h3>
        <p class="text-sm">Baue beeindruckende Seiten mit wenigen Klicks. Einfach, schnell und professionell gestaltet.</p>
      </a>
      <a href="/de/smartdomain" class="rounded-2xl p-5 text-white bg-gradient-to-r from-[#8B5CFF] to-[#A076FF]
        shadow-[0_6px_16px_rgba(0,0,0,0.12)] transition-all duration-300 hover:shadow-[0_0_25px_rgba(139,92,255,0.6)] hover:scale-[1.02]">
        <h3 class="text-2xl font-bold mb-2">SmartDomain</h3>
        <p class="text-sm">Sichere deine eigene Domain direkt in SmartPages ‚Äì professionell, einfach und DSGVO-konform.</p>
      </a>
    </section>
  </div>

  <!-- Fallback (nicht eingeloggt) -->
  <div id="login-status" class={authenticated ? "hidden" : "max-w-4xl mx-auto mt-20 text-center"}>
    <h2 class="text-2xl font-bold text-[#1E2A45]">Anmeldung wird gepr√ºft...</h2>
  </div>

  <!-- üîπ Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
    <div class="bg-white rounded-2xl shadow-lg p-8 w-[90%] max-w-lg">
      <h3 id="modalTitle" class="text-xl font-semibold mb-4 text-[#1E2A45]">Daten bearbeiten</h3>
      <form id="modalForm" class="space-y-4">
        <input type="text" id="input1" placeholder="Vorname" class="w-full border border-gray-300 rounded-lg px-3 py-2" />
        <input type="text" id="input2" placeholder="Nachname" class="w-full border border-gray-300 rounded-lg px-3 py-2" />
        <input type="email" id="input3" placeholder="E-Mail" class="w-full border border-gray-300 rounded-lg px-3 py-2" />
      </form>
      <div class="flex justify-end mt-6 gap-3">
        <button id="cancelModal" class="px-4 py-2 bg-gray-200 text-[#1E2A45] rounded-lg hover:bg-gray-300">Abbrechen</button>
        <button id="saveModal" class="px-4 py-2 text-white rounded-lg bg-gradient-to-r from-[#F5B400] to-[#E47E00] hover:opacity-90">
          Speichern
        </button>
      </div>
    </div>
  </div>
</PageLayout>

<!-- JS -->
<script>
window.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("modal");
  const openUser = document.getElementById("editUserBtn");
  const openImprint = document.getElementById("editImprintBtn");
  const cancelModal = document.getElementById("cancelModal");
  const saveModal = document.getElementById("saveModal");

  let mode = "user"; // 'user' oder 'imprint'

  openUser?.addEventListener("click", () => {
    mode = "user";
    modal.classList.remove("hidden");
    document.getElementById("modalTitle").innerText = "Kundendaten bearbeiten";
  });

  openImprint?.addEventListener("click", () => {
    mode = "imprint";
    modal.classList.remove("hidden");
    document.getElementById("modalTitle").innerText = "Impressum bearbeiten";
  });

  cancelModal?.addEventListener("click", () => {
    modal.classList.add("hidden");
  });

  saveModal?.addEventListener("click", async () => {
    const inputs = Array.from(document.querySelectorAll("#modalForm input"));
    const body = {};
    inputs.forEach((i) => (body[i.placeholder.toLowerCase()] = i.value));

    const url =
      mode === "user"
        ? "https://api.smartpages.online/api/user/update"
        : "https://api.smartpages.online/api/imprint/update";

    try {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(body),
      });
      const result = await res.json();
      if (result.ok) {
        alert("‚úÖ √Ñnderungen gespeichert!");
        modal.classList.add("hidden");
        location.reload();
      } else {
        alert("‚ùå Fehler: " + (result.error || "Unbekannter Fehler"));
      }
    } catch (err) {
      alert("‚ö†Ô∏è Verbindung fehlgeschlagen.");
    }
  });
});
</script>

<style>
section {
  scroll-margin-top: 1.5rem;
}
section h2 {
  line-height: 1.2;
}
section p {
  line-height: 1.4;
}
.grid p {
  margin-bottom: 0.25rem;
}
section.max-w-6xl {
  margin-top: 1rem !important;
  padding-top: 1.25rem;
  padding-bottom: 1.25rem;
}
</style>
