---
import PageLayout from "~/layouts/PageLayout.astro";
import DashboardCardWide from "~/components/core/DashboardCardWide.astro";
---

<PageLayout title="Dashboard ‚Äì SmartPages" sidebar={true} header={true}>

  <!-- üß≠ Dashboard Container -->
  <div id="dashboard-container" class="hidden">
    <DashboardCardWide
      id="card-user"
      title="Willkommen zur√ºck üëã"
      showStatus={true}
      status="Eingeloggt"
      statusColor="green"
    >
      <form
        id="form-customer"
        class="grid grid-cols-1 md:grid-cols-3 gap-x-12 gap-y-3 text-sm text-gray-700"
      >
        <p>
          <label class="font-semibold">Name</label>
          <input
            type="text"
            name="name"
            id="name"
            class="p-2 border rounded-lg w-full border-gray-300"
          />
        </p>
        <p>
          <label class="font-semibold">E-Mail</label>
          <input
            type="email"
            name="email"
            id="email"
            class="p-2 border rounded-lg w-full border-gray-300"
          />
        </p>
        <p>
          <label class="font-semibold">Kundentyp</label>
          <input
            type="text"
            name="type"
            id="type"
            class="p-2 border rounded-lg w-full border-gray-300 bg-gray-50"
            readonly
          />
        </p>

        <div class="md:col-span-3 flex justify-center mt-4">
          <button
            type="submit"
            class="px-6 py-2 bg-[#1E2A45] text-white rounded-xl hover:bg-[#2B3B60] transition-all"
          >
            Kundendaten verarbeiten
          </button>
        </div>
      </form>
    </DashboardCardWide>

    <DashboardCardWide
      title="Impressum & Datenschutz"
      desc="Diese Angaben werden automatisch f√ºr dein Impressum und deine Datenschutzseite verwendet."
    >
      <form
        id="form-legal"
        class="grid md:grid-cols-2 gap-4"
      >
        <div>
          <label class="text-sm font-medium text-gray-700">Firmenname</label>
          <input
            type="text"
            name="company_name"
            id="company_name"
            class="p-2 border rounded-lg w-full border-gray-300"
          />
        </div>

        <div>
          <label class="text-sm font-medium text-gray-700">Ansprechpartner</label>
          <input
            type="text"
            name="contact_person"
            id="contact_person"
            class="p-2 border rounded-lg w-full border-gray-300"
          />
        </div>

        <div>
          <label class="text-sm font-medium text-gray-700">Kontakt-E-Mail</label>
          <input
            type="email"
            name="email"
            id="legal_email"
            class="p-2 border rounded-lg w-full border-gray-300"
          />
        </div>

        <div class="md:col-span-2">
          <label class="text-sm font-medium text-gray-700">Adresse</label>
          <textarea
            rows="3"
            name="address"
            id="address"
            class="p-2 border rounded-lg w-full border-gray-300"
          ></textarea>
        </div>

        <div class="md:col-span-2 flex justify-center mt-4">
          <button
            type="submit"
            class="px-6 py-2 bg-[#F5B400] text-[#1E2A45] rounded-xl hover:bg-[#E47E00] transition-all"
          >
            Impressumsdaten verarbeiten
          </button>
        </div>
      </form>
    </DashboardCardWide>
  </div>

  <!-- üö´ Login Required -->
  <div id="login-required" class="max-w-4xl mx-auto mt-20 text-center hidden">
    <h2 class="text-2xl font-bold text-[#1E2A45]">Anmeldung erforderlich</h2>
    <p class="text-gray-600 mt-3">Bitte melde dich erneut √ºber deinen Magic Link an.</p>
    <a
      href="/de/login"
      class="inline-block mt-6 px-6 py-3 bg-[#F5B400] text-[#1E2A45] rounded-xl hover:bg-[#E47E00] transition-all"
    >
      Zum Login
    </a>
  </div>

</PageLayout>

<script>
  // üåê Session pr√ºfen und Dashboard dynamisch laden
  document.addEventListener("DOMContentLoaded", async () => {
    try {
      const res = await fetch("https://api.smartpages.online/api/session", {
        credentials: "include",
      });
      const session = await res.json();

      if (!session.ok || !session.authenticated) {
        document.getElementById("login-required").classList.remove("hidden");
        return;
      }

      // Benutzerinformationen abrufen
      const userRes = await fetch("https://customer.smartpages.online/api/user-data", {
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${session.session?.email}`,
        },
      });

      const userData = await userRes.json();
      const user = userData.user;

      if (!user) {
        document.getElementById("login-required").classList.remove("hidden");
        return;
      }

      // üéØ Formulare mit Daten f√ºllen
      document.getElementById("name").value = `${user.first_name || ""} ${user.last_name || ""}`;
      document.getElementById("email").value = user.email || "";
      document.getElementById("type").value = user.is_business ? "Business" : "Privat";

      document.getElementById("company_name").value = user.company_name || "";
      document.getElementById("contact_person").value = `${user.first_name || ""} ${user.last_name || ""}`.trim();
      document.getElementById("legal_email").value = user.email || "";
      document.getElementById("address").value = user.address || "";

      document.getElementById("dashboard-container").classList.remove("hidden");
    } catch (err) {
      console.error("Fehler beim Laden der Session:", err);
      document.getElementById("login-required").classList.remove("hidden");
    }
  });

  // üíæ Formular-Handler
  async function handleSubmit(e, formId) {
    e.preventDefault();
    const form = document.getElementById(formId);
    const data = Object.fromEntries(new FormData(form));

    const res = await fetch("https://customer.smartpages.online/api/user-update", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data),
    });

    if (res.ok) {
      alert("‚úÖ Daten erfolgreich verarbeitet!");
    } else {
      alert("‚ùå Fehler beim Speichern. Bitte erneut versuchen.");
    }
  }
</script>
