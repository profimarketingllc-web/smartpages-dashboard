---
import PageLayout from "~/layouts/PageLayout.astro";
import DashboardCardWide from "~/components/core/DashboardCardWide.astro";
import "~/styles/global.css";

let user = null;
let authenticated = false;

// üß© Serverseitiger Session-Fallback (Cookie aus Request-Header)
try {
  const cookie = Astro.request.headers.get("cookie") || "";
  if (cookie.includes("session=")) {
    const res = await fetch("https://api.smartpages.online/api/session", {
      method: "GET",
      headers: {
        "Accept": "application/json",
        "Cookie": cookie,
      },
      credentials: "include",
    });

    const data = await res.json();
    if (data.ok && data.authenticated) {
      user = data.user;
      authenticated = true;
    }
  }
} catch (err) {
  console.warn("Server-side session check failed:", err);
}
---

<PageLayout title="Dashboard ‚Äì SmartPages" sidebar={true} header={true}>
  <div id="dashboard-content" class="max-w-4xl mx-auto mt-20 text-center">
    {authenticated ? (
      <DashboardCardWide
        title={`Willkommen zur√ºck, ${user?.first_name || "Unbekannt"} üëã`}
        showStatus={true}
        status="Eingeloggt"
        statusColor="green"
      >
        <p class="text-gray-700">Du bist erfolgreich angemeldet!</p>
      </DashboardCardWide>
    ) : (
      <div id="login-status">
        <h2 class="text-2xl font-bold text-[#1E2A45]">Anmeldung wird gepr√ºft...</h2>
      </div>
    )}
  </div>
</PageLayout>

<script>
window.addEventListener("DOMContentLoaded", async () => {
  const container = document.getElementById("dashboard-content");
  const statusBox = document.getElementById("login-status");

  try {
    const res = await fetch("https://api.smartpages.online/api/session", {
      method: "GET",
      credentials: "include",
      headers: { "Accept": "application/json" },
    });

    const data = await res.json();

    if (data.ok && data.authenticated) {
      // ‚úÖ Direkt User-Dashboard anzeigen (kein Reload!)
      container.innerHTML = `
        <div class="rounded-2xl shadow bg-white p-8 text-center">
          <h2 class="text-3xl font-bold text-[#1E2A45]">
            Willkommen zur√ºck, ${data.user.first_name || "Unbekannt"} üëã
          </h2>
          <p class="mt-3 text-gray-700">Du bist erfolgreich angemeldet.</p>
        </div>
      `;
    } else {
      // ‚ùå Kein Login ‚Üí Login auffordern
      statusBox.innerHTML = `
        <h2 class='text-2xl font-bold text-[#1E2A45]'>Anmeldung erforderlich</h2>
        <p class='text-gray-600 mt-3'>Bitte melde dich erneut √ºber deinen Magic Link an.</p>
        <a href="/de/login"
           class="inline-block mt-6 px-6 py-3 bg-[#F5B400] text-[#1E2A45] rounded-xl hover:bg-[#E47E00] transition-all">
           Zum Login
        </a>`;
    }
  } catch (e) {
    console.error("Client session fetch failed:", e);
    statusBox.innerHTML = `
      <h2 class='text-2xl font-bold text-[#1E2A45]'>Verbindungsfehler</h2>
      <p class='text-gray-600 mt-3'>Bitte versuche es in ein paar Minuten erneut.</p>`;
  }
});
</script>

<style>
body {
  font-family: "Inter", sans-serif;
  background-color: #f9fafb;
}
</style>
