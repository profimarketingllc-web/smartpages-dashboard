---
import { onMount } from 'solid-js';

let loading = true;
let userData = null;

onMount(async () => {
  const statusPill = document.querySelector('#status-pill');
  const loader = document.querySelector('#loader-screen');
  const dashboard = document.querySelector('#dashboard-content');

  try {
    const res = await fetch('/api/user/profile', {
      method: 'GET',
      credentials: 'include',
      headers: { 'Accept': 'application/json' },
    });

    const data = await res.json();

    if (data.ok && data.user) {
      userData = data.user;

      // Felder injizieren
      document.querySelector('[data-name]').textContent =
        `${userData.first_name || ''} ${userData.last_name || ''}`.trim() || 'Gast';
      document.querySelector('[data-plan]').textContent = userData.plan || 'â€”';
      document.querySelector('[data-status]').textContent = userData.status || 'inactive';
      document.querySelector('[data-login]').textContent =
        userData.last_login ? new Date(userData.last_login).toLocaleString() : 'â€”';

      // Status-Pill: Eingeloggt
      statusPill.textContent = 'Eingeloggt';
      statusPill.classList.remove('bg-red-200', 'text-red-700');
      statusPill.classList.add('bg-green-200', 'text-green-700');
    } else {
      // Nicht autorisiert â†’ Abgemeldet
      throw new Error('unauthorized');
    }
  } catch (err) {
    console.warn('User nicht autorisiert oder Fehler beim Abruf:', err);

    // Leere Felder setzen
    document.querySelectorAll('[data-value]').forEach((el) => (el.textContent = 'â€”'));

    // Status-Pill: Abgemeldet
    statusPill.textContent = 'Abgemeldet';
    statusPill.classList.remove('bg-green-200', 'text-green-700');
    statusPill.classList.add('bg-red-200', 'text-red-700');
  } finally {
    // Loader ausblenden, Dashboard zeigen
    loader.style.display = 'none';
    dashboard.style.display = 'block';
    loading = false;
  }
});
---

<!-- Loader Screen -->
<div id="loader-screen" class="flex flex-col items-center justify-center h-screen text-center">
  <h2 class="text-xl font-semibold text-gray-800">Anmeldung wird geprÃ¼ft...</h2>
</div>

<!-- Dashboard Content -->
<div id="dashboard-content" class="hidden p-8 space-y-6">

  <!-- Header -->
  <header class="flex items-center justify-between">
    <h1 class="text-2xl font-bold text-gray-900">Willkommen zurÃ¼ck, <span data-name>Gast</span> ðŸ‘‹</h1>
    <span id="status-pill" class="rounded-full px-3 py-1 text-sm bg-red-200 text-red-700">Abgemeldet</span>
  </header>

  <!-- Customer Card -->
  <section class="bg-white rounded-2xl shadow p-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Kundendaten</h2>
    <div class="grid grid-cols-2 gap-y-2 text-sm text-gray-700">
      <div>Name: <span data-value data-name="name">â€”</span></div>
      <div>Plan: <span data-value data-plan>â€”</span></div>
      <div>Status: <span data-value data-status>â€”</span></div>
      <div>Letztes Login: <span data-value data-login>â€”</span></div>
    </div>
    <div class="mt-4 text-center">
      <button id="editCustomerBtn" class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-5 py-2 rounded-xl shadow hover:opacity-90 transition">
        Kundendaten bearbeiten
      </button>
    </div>
  </section>

  <!-- Impressum Card -->
  <section class="bg-white rounded-2xl shadow p-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Impressumsdaten</h2>
    <div class="grid grid-cols-2 gap-y-2 text-sm text-gray-700">
      <div>Unternehmen: <span data-value>â€”</span></div>
      <div>Ansprechpartner: <span data-value>â€”</span></div>
      <div>Zusatz: <span data-value>â€”</span></div>
      <div>StraÃŸe & Hausnummer: <span data-value>â€”</span></div>
      <div>PLZ / Ort: <span data-value>â€”</span></div>
      <div>E-Mail (Support): <span data-value>â€”</span></div>
      <div>USt-ID: <span data-value>â€”</span></div>
    </div>
    <div class="mt-4 text-center">
      <button id="editImpressumBtn" class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-5 py-2 rounded-xl shadow hover:opacity-90 transition">
        Impressum bearbeiten
      </button>
    </div>
  </section>

  <!-- Footer -->
  <footer class="text-center text-sm text-gray-500 mt-10">
    Â© 2026 SmartPages Â· Hosted in Europe Â· GDPR-compliant
  </footer>

</div>
