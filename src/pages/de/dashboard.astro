---
import SmartHeader from "@/components/core/SmartHeader.astro";
import SmartSidebar from "@/components/core/SmartSidebar.astro";
import ProductCardGrid from "@/components/core/ProductCardGrid.astro";
import DashboardCardWide from "@/components/core/DashboardCardWide.astro";
import CustomerCard from "@/components/core/CustomerCard.jsx";

let user = null;
let isLoading = true;
let isAuthorized = false;

try {
  const res = await fetch("https://api.smartpages.online/api/user/profile", {
    headers: Astro.request.headers,
  });

  if (res.ok) {
    const data = await res.json();
    user = data.user;
    isAuthorized = true;
  }
} catch (e) {
  isAuthorized = false;
}
isLoading = false;
---

<html lang="de">
  <head>
    <meta charset="utf-8" />
    <title>Dashboard â€“ SmartPages</title>
  </head>

  <body class="min-h-screen flex flex-col bg-gray-50 text-gray-800">
    <SmartHeader />

    <div class="flex flex-1 overflow-hidden">
      <SmartSidebar />

      <main class="flex-1 flex flex-col p-6 md:p-10 space-y-6 overflow-y-auto">
        {isLoading ? (
          <div class="flex flex-col items-center justify-center h-64 text-gray-600">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-4"></div>
            <p>In PrÃ¼fungâ€¦</p>
          </div>
        ) : (
          <>
            <!-- ðŸ§© Customer Info -->
            <DashboardCardWide>
              <CustomerCard client:load />
            </DashboardCardWide>

            <!-- ðŸ§¾ Impressum -->
            <DashboardCardWide>
              <div class="p-4 md:p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-2">
                  Impressumsdaten
                </h2>
                {isAuthorized ? (
                  <p class="text-gray-600">
                    Unternehmen: {user.company_name ?? "â€”"} <br />
                    Ansprechpartner: {user.first_name ?? "â€”"} {user.last_name ?? ""} <br />
                    Status: {user.status ?? "â€”"} <br />
                    Aktiv bis: {user.trial_end ?? "â€”"}
                  </p>
                ) : (
                  <p class="text-gray-400 italic">Nicht verfÃ¼gbar (Abgemeldet)</p>
                )}
              </div>
            </DashboardCardWide>

            <!-- ðŸ’¡ ProduktÃ¼bersicht -->
            <DashboardCardWide>
              <ProductCardGrid />
            </DashboardCardWide>

            <!-- ðŸ’¬ Feedback -->
            <DashboardCardWide>
              <div class="text-center py-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">
                  Feedback geben
                </h3>
                <p class="text-gray-600 mb-4">
                  Hilf uns, SmartPages noch besser zu machen! Teile dein Feedback mit unserem Team.
                </p>
                <a
                  href="mailto:support@smartpages.online"
                  class="px-5 py-2 rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-medium shadow hover:opacity-90 transition"
                >
                  Nachricht an das Team
                </a>
              </div>
            </DashboardCardWide>
          </>
        )}
      </main>
    </div>

    <footer
      class="bg-gray-50 text-gray-500 text-center py-4 text-sm border-t border-gray-200"
    >
      Â© 2026 SmartPages Â· Hosted in Europe Â· GDPR-compliant
    </footer>
  </body>
</html>
