---
import PageLayout from "~/layouts/PageLayout.astro";
import "~/styles/global.css";

let user = {
  name: "Gastbenutzer",
  email: "unbekannt",
  status: "Kostenlos",
  plan: "—",
  aktivBis: "—",
  letztesLogin: "—",
};
let authenticated = false;

try {
  const cookie = Astro.request.headers.get("cookie") || "";
  if (cookie.includes("session=")) {
    const res = await fetch("https://api.smartpages.online/api/user/profile", {
      method: "GET",
      headers: { Accept: "application/json", Cookie: cookie },
      credentials: "include",
    });
    const data = await res.json();

    if (data.ok && data.user) {
      authenticated = true;
      user = {
        name: data.user.first_name || "Gastbenutzer",
        email: data.user.email || "unbekannt",
        status: data.user.status || "inactive",
        plan: data.user.plan || "Trial",
        aktivBis: data.user.trial_end || "—",
        letztesLogin: data.user.last_login || "—",
      };
    }
  }
} catch (err) {
  console.warn("Sessionprüfung fehlgeschlagen:", err);
}
---
