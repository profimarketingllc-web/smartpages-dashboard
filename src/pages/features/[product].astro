---
import PageLayout from "~/layouts/PageLayout.astro";

// ðŸ”’ Feste Produktliste fÃ¼r Static Build
const PRODUCTS = [
  "smartprofile",
  "smartpage",
  "smartlinks",
  "smartdomain",
];

// â­ PFLICHT fÃ¼r Static + Dynamic Routes
export function getStaticPaths() {
  return PRODUCTS.map((product) => ({
    params: { product },
  }));
}

const { product } = Astro.params;
const isValid = PRODUCTS.includes(product);
---

<PageLayout sidebar header>
  <main class="max-w-4xl mx-auto px-6 py-10 flex flex-col gap-10">

    {isValid ? (
      <>
        <section class="flex flex-col gap-3">
          <h1 class="text-3xl font-extrabold capitalize">
            {product}
          </h1>
          <p class="text-lg text-gray-600">
            Erfahre, was dieses Produkt kann und schalte es frei.
          </p>
        </section>

        <section
          id="product-features"
          class="flex flex-col gap-6 text-gray-500"
        >
          Lade Produktinformationenâ€¦
        </section>

        <section class="text-center mt-10">
          <button
            id="upgrade-btn"
            disabled
            class="opacity-50 cursor-not-allowed bg-gray-300 text-gray-600
                   px-8 py-4 rounded-xl text-lg font-semibold"
          >
            Upgrade wird geladenâ€¦
          </button>
        </section>
      </>
    ) : (
      <p class="text-center text-gray-500">
        Unbekanntes Produkt.
      </p>
    )}
  </main>
</PageLayout>

<script>
  (async function () {
    const user = window.SMARTPAGES_USER;
    if (!user) return;

    const product = "{product}";
    const container = document.getElementById("product-features");
    const button = document.getElementById("upgrade-btn");

    try {
      const res = await fetch(
        "https://api.smartpages.online/api/billing/product-info?product=" + product,
        { credentials: "include" }
      );

      if (!res.ok) {
        container.textContent = "Produktdaten konnten nicht geladen werden.";
        return;
      }

      const data = await res.json();

      container.innerHTML = "";
      data.features.forEach((f) => {
        const el = document.createElement("div");
        el.className = "bg-white rounded-xl shadow p-4";
        el.innerHTML = "<strong>" + f.title + "</strong><p>" + f.text + "</p>";
        container.appendChild(el);
      });

      if (user.active_products?.includes(product)) {
        button.textContent = "Produkt bereits aktiv";
        return;
      }

      button.disabled = false;
      button.textContent = "Jetzt freischalten";
      button.className =
        "bg-black text-white px-8 py-4 rounded-xl text-lg font-semibold";

      button.onclick = async () => {
        const res = await fetch(
          "https://api.smartpages.online/api/billing/checkout?product=" + product,
          { credentials: "include" }
        );
        const result = await res.json();
        if (result?.url) window.location.href = result.url;
      };
    } catch (e) {
      console.error(e);
    }
  })();
</script>
