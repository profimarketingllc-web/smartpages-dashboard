---
import PageLayout from "~/layouts/PageLayout.astro";
import ProductPill from "~/components/shared/ProductPill.astro";

// ‚ö†Ô∏è KEIN prerender = false
// ‚ö†Ô∏è KEIN Astro.locals
// ‚ö†Ô∏è KEIN Astro.redirect

const { product } = Astro.params;

// Nur Whitelist ‚Äì Sicherheit bleibt im Backend
const allowedProducts = [
  "smartprofile",
  "smartpage",
  "smartlinks",
  "smartdomain",
];

// Statischer Fallback (Build-sicher)
const isAllowed = allowedProducts.includes(product);
---

<PageLayout sidebar header>
  <main class="max-w-4xl mx-auto px-6 py-10 flex flex-col gap-10">

    {isAllowed ? (
      <>
        <!-- üß† Produktkopf -->
        <section class="flex flex-col gap-4">
          <h1 class="text-3xl font-extrabold capitalize">
            {product}
          </h1>
          <p class="text-lg text-gray-600">
            Entdecke alle Vorteile dieses Produkts und schalte es
            mit einem Klick frei.
          </p>
        </section>

        <!-- üß© Feature-Container (Client) -->
        <section id="product-features" class="flex flex-col gap-6">
          <p class="text-gray-400">Lade Produktdetails‚Ä¶</p>
        </section>

        <!-- üí≥ CTA -->
        <section class="text-center mt-10">
          <button
            id="upgrade-btn"
            disabled
            class="opacity-50 cursor-not-allowed bg-gray-300 text-gray-600 px-8 py-4 rounded-xl text-lg font-semibold"
          >
            Upgrade wird geladen‚Ä¶
          </button>
        </section>
      </>
    ) : (
      <p class="text-center text-gray-500">
        Unbekanntes Produkt.
      </p>
    )}
  </main>
</PageLayout>

<!-- ===================================================== -->
<!-- üîê CLIENT LOGIC: Product Fencing + Stripe Redirect   -->
<!-- ===================================================== -->
<script>
  (async function () {
    if (!window.SMARTPAGES_USER) return;

    const product = "{product}";
    const container = document.getElementById("product-features");
    const button = document.getElementById("upgrade-btn");

    try {
      // üîé Produktdetails vom Backend holen
      const res = await fetch(
        "https://api.smartpages.online/api/billing/product-info?product=" + product,
        { credentials: "include" }
      );

      if (!res.ok) {
        container.innerHTML =
          "<p class='text-red-500'>Produktdaten konnten nicht geladen werden.</p>";
        return;
      }

      const data = await res.json();

      // üß© Features rendern
      container.innerHTML = "";
      data.features.forEach((f) => {
        const el = document.createElement("div");
        el.className = "bg-white rounded-xl shadow p-4";
        el.innerHTML = "<strong>" + f.title + "</strong><p>" + f.text + "</p>";
        container.appendChild(el);
      });

      // üîì Wenn User Produkt schon hat ‚Üí zur√ºck
      if (window.SMARTPAGES_USER.active_products?.includes(product)) {
        button.textContent = "Produkt bereits aktiv";
        button.disabled = true;
        return;
      }

      // üí≥ Upgrade aktivieren
      button.disabled = false;
      button.textContent = "Jetzt freischalten";
      button.className =
        "bg-black text-white px-8 py-4 rounded-xl text-lg font-semibold hover:opacity-90";

      button.onclick = async () => {
        const checkout = await fetch(
          "https://api.smartpages.online/api/billing/checkout?product=" + product,
          { credentials: "include" }
        );

        const result = await checkout.json();
        if (result?.url) {
          window.location.href = result.url;
        }
      };
    } catch (e) {
      console.error(e);
    }
  })();
</script>
