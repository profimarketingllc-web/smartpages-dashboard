---
import PageLayout from "~/layouts/PageLayout.astro";
import ProductGrid from "~/components/shared/ProductGrid.astro";
import { productGridI18n } from "~/utils/i18n/ProductGrid";
import { t } from "~/utils/i18n/i18n";

const lang = Astro.props.lang ?? "de";
---

<PageLayout lang={lang} page="login" sidebar={false} header={true}>

  <!-- HERO + FORM -->
  <section class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">

    <!-- HERO -->
    <div class="bg-white rounded-xl shadow p-6">
      <h2 class="text-xl font-bold mb-2">
        {t(lang, "login", "hero", "title")}
      </h2>
      <p class="text-sm text-gray-600 leading-snug">
        {t(lang, "login", "hero", "text")}
      </p>
    </div>

    <!-- FORM -->
    <div class="bg-white rounded-xl shadow p-6">
      <div class="grid gap-3">

        <label class="text-sm font-medium">
          {t(lang, "login", "form", "firstName")}
          <span class="text-red-500">*</span>
        </label>
        <input id="firstName" class="h-9 px-3 rounded border bg-gray-100 text-sm" />

        <label class="text-sm font-medium">
          {t(lang, "login", "form", "lastName")}
        </label>
        <input id="lastName" class="h-9 px-3 rounded border bg-gray-100 text-sm" />

        <label class="text-sm font-medium">
          {t(lang, "login", "form", "email")}
          <span class="text-red-500">*</span>
        </label>
        <input id="email" type="email" class="h-9 px-3 rounded border bg-gray-100 text-sm" />

        <div
          id="businessBox"
          class="mt-2 cursor-pointer rounded-lg border border-dashed text-sm text-gray-600 p-3 text-center hover:bg-gray-50"
        >
          {t(lang, "login", "form", "businessToggle")}
        </div>

        <div id="companyField" class="hidden">
          <label class="text-sm font-medium mt-2 block">
            {t(lang, "login", "form", "company")}
          </label>
          <input id="company" class="h-9 px-3 rounded border bg-gray-100 text-sm w-full" />
        </div>

        <button
          id="sendBtn"
          disabled
          class="mt-4 mx-auto w-3/4 h-10 rounded-lg font-semibold text-white bg-[#F5B400] disabled:opacity-50"
        >
          {t(lang, "login", "form", "button")}
        </button>

        <p class="text-xs text-gray-500 text-center mt-2 leading-snug">
          {t(lang, "login", "form", "hint")}
        </p>
      </div>
    </div>
  </section>

  <!-- PRODUCT GRID (BLEIBT!) -->
  <section class="mt-12">
    <ProductGrid lang={lang} upsell={productGridI18n[lang].teaser} />
  </section>

</PageLayout>

<!-- ===================== -->
<!-- PREMIUM MODAL -->
<!-- ===================== -->
<div
  id="loginModal"
  class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50"
>
  <div class="bg-white rounded-2xl shadow-strong p-6 max-w-sm w-full text-center">
    <div
      id="modalSpinner"
      class="mx-auto mb-4 h-10 w-10 rounded-full border-4 border-gray-200 border-t-[#F5B400] animate-spin hidden"
    ></div>

    <div id="modalIcon" class="text-3xl mb-3 hidden"></div>

    <h3 id="modalTitle" class="text-lg font-bold mb-2"></h3>
    <p id="modalText" class="text-sm text-gray-600 mb-5"></p>

    <button
      id="modalBtn"
      class="px-6 py-2 rounded-lg font-semibold text-white hidden"
    >
      OK
    </button>
  </div>
</div>

<script>
  const firstName = document.getElementById("firstName");
  const email = document.getElementById("email");
  const companyBox = document.getElementById("businessBox");
  const companyField = document.getElementById("companyField");
  const sendBtn = document.getElementById("sendBtn");

  const modal = document.getElementById("loginModal");
  const modalSpinner = document.getElementById("modalSpinner");
  const modalIcon = document.getElementById("modalIcon");
  const modalTitle = document.getElementById("modalTitle");
  const modalText = document.getElementById("modalText");
  const modalBtn = document.getElementById("modalBtn");

  function validate() {
    sendBtn.disabled = !firstName.value.trim() || !email.value.trim();
  }

  firstName.addEventListener("input", validate);
  email.addEventListener("input", validate);

  companyBox.addEventListener("click", () => {
    companyBox.classList.add("hidden");
    companyField.classList.remove("hidden");
  });

  function openModal() {
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }

  function closeModal() {
    modal.classList.add("hidden");
  }

  function showLoading() {
    openModal();
    modalSpinner.classList.remove("hidden");
    modalIcon.classList.add("hidden");
    modalBtn.classList.add("hidden");
    modalTitle.textContent = "Magic-Link wird gesendet…";
    modalText.textContent = "Bitte einen Moment warten.";
  }

  function showSuccess() {
    modalSpinner.classList.add("hidden");
    modalIcon.textContent = "✅";
    modalIcon.classList.remove("hidden");
    modalTitle.textContent = "Magic-Link gesendet";
    modalText.textContent = "Bitte prüfe dein E-Mail-Postfach.";
    modalBtn.className = "px-6 py-2 rounded-lg font-semibold text-white bg-green-600";
    modalBtn.classList.remove("hidden");
  }

  function showError() {
    modalSpinner.classList.add("hidden");
    modalIcon.textContent = "❌";
    modalIcon.classList.remove("hidden");
    modalTitle.textContent = "Fehler";
    modalText.textContent = "Bitte versuche es erneut.";
    modalBtn.className = "px-6 py-2 rounded-lg font-semibold text-white bg-red-600";
    modalBtn.classList.remove("hidden");
    sendBtn.disabled = false;
  }

  modalBtn.addEventListener("click", () => {
    closeModal();
    window.close();
  });

  sendBtn.addEventListener("click", async () => {
    showLoading();
    sendBtn.disabled = true;

    try {
      const res = await fetch("https://api.smartpages.online/api/auth/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          first_name: firstName.value,
          last_name: document.getElementById("lastName").value,
          email: email.value,
          company: document.getElementById("company")?.value || null,
          lang: "{lang}",
        }),
      });

      const data = await res.json();
      if (!res.ok || !data?.ok) throw new Error();
      showSuccess();
    } catch {
      showError();
    }
  });
</script>
